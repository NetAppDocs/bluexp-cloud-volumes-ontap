---
sidebar: sidebar
permalink: task-azure-image-export.html
keywords: Azure, image, VHD, image signature file, export, marketplace,
summary: You can export ONTAP images from the Azure Marketplace to verify the signature of the VHD file. 
---

= Image export from Azure Marketplace
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Once the VHD image is published to Azure cloud, the image is no longer managed by NetApp. Instead, the published image is placed on the Azure marketplace. Azure's alteration to the leading 1MB and ending 512B of the VHD occurs when the image is staged and published on the Azure marketplace. To verify the signature of the VHD file, the running VHD image modified by Azure needs to be exported from the Azure marketplace first.

.What you'll need

You must install the required programs on your system. 

* Azure CLI is installed or Azure Cloud Shell through the Azure portal is readily available. 
+ 
NOTE: For more information on how to install Azure CLI, see https://learn.microsoft.com/en-us/cli/azure/install-azure-cli[Azure documentation: How to install Azure CLI^].

.Steps

. From BlueXP, find the Cloud Volumes ONTAP software version when configuring your deployment.
+
image:screenshot_cvo_software_version.png[A screenshot showing Cloud Volumes ONTAP software versions available when configuring a deployment in BlueXP.]

. Map the Cloud Volumes ONTAP version to the Azure marketplace image version. 
+
For example, Cloud Volumes ONTAP 9.15.0 maps to Azure 9.150.20240213. This Azure marketplace image version is used to locate an image definition in the next step.
+
[cols="1,1"]
|===
|Cloud Volumes ONTAP Software Version |Azure Marketplace image version

|9.15.0
|9.150.20240213

|===

. Once the Cloud Volumes ONTAP software version and Azure marketplace image are verified, export the VHD file from Azure marketplace through Azure Cloud Shell or Azure CLI.
+
*Azure Cloud Shell on Azure portal*
+
** From Azure Cloud Shell, export the marketplace image to a vhd, and download to your local server (for example, a Linux machine, or a windows PC.)
+
.Click to display the script
[%collapsible]
+
====

[source]
----
#Azure Cloud Shell on Azure portal to get VHD image from Azure Marketplace
a) List our marketplace images
PS /home/user1> az vm image list --all --publisher netapp --offer offer-example-one --sku osku_example_for_one
...
{
"architecture": "x64",
"offer": "netapp-ontap-cloud",
"publisher": "netapp",
"sku": "ontap_cloud_pgo_sn",
"urn": "netapp:offer-example-one:sku_example_for_one::9.110.20220302",
"version": "9.110.20220302"
},
...
 
b) Create a new managed disk from the Marketplace image with the matching image version
PS /home/user1> $urn = “netapp:offer-example-one:sku_example_for_one::9.110.20220302”
PS /home/user1> $diskName = “9.110.20220302-managed-disk"
PS /home/user1> $diskRG = “fnf1”
PS /home/user1> az disk create -g $diskRG -n $diskName --image-reference $urn
PS /home/user1> $sas = az disk grant-access --duration-in-seconds 36000 --access-level Read --name $diskName --resource-group $diskRG
PS /home/user1> $diskAccessSAS = ($sas | ConvertFrom-Json)[0].accessSas
 
c) Export a VHD from the managed disk to Azure Storage
Create a container with proper access level. As an example, a container named 'vi-images' with 'Container' access level is used here.
Get storage account access key, on Azure portal, 'Storage Accounts'/'signimgsa'/'Access Key'/'key1'/'key'/'show'/<copy>.
PS /home/user1> $storageAccountName = “accountnameexample”
PS /home/user1> $containerName = “cname-example”
PS /home/user1> $storageAccountKey = "<replace with the above access key>"
PS /home/user1> $destBlobName = “9.110.20220302.vhd”
PS /home/user1> $destContext = New-AzureStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey
PS /home/user1> Start-AzureStorageBlobCopy -AbsoluteUri $diskAccessSAS -DestContainer $containerName -DestContext $destContext -DestBlob $destBlobName
PS /home/user1> Get-AzureStorageBlobCopyState –Container $containerName –Context $destContext -Blob $destBlobName
 
d) Download the generated image to your server, e.g., a SCS server or a windows PC.
On Linux in OpenLab, use "wget <URL of file signimgsa/Containers/vm-images/9.110.20220302.vhd>".
The URL is organized in a formatted way. For automation tasks, the following example could be used to derive the URL string. Otherwise, Azure CLI 'az' command could be issued to get the URL, which is not covered in this guide. URL Example:
https://accountnameexample.blob.core.windows.net/cname-example/9.110.20220302.vhd
 
Or, on windows, use Azure Storage Explorer to 'Attach to a resource' for fast download. Generate SAS of the image container: 'accountnameexample'/'cname-example', then feed the SAS to Azure Storage Explorer.
 
Or, on Mac, mount your local user directory on your MAC so you can copy the exported VHD from the marketplace over and run openssl command against it from the cycl-server:
command+k (on Finder) and use this mountpoint:  smb://vsvhdrdur01prd.corp.netapp.com
login as "NETAPP\<sso>" and then enter password as a "Registered Guest"
 
e) Clean up the managed disk
az disk revoke-access --name $diskName --resource-group $diskRG
az disk delete --name $diskName --resource-group $diskRG --yes
----

====

+
*Azure CLI from local Linux machine*
** Perform the following to export the marketplace image to a vhd through the Azure CLI from a local Linux machine.
+
.Click to display the script
[%collapsible]
+
====

[source]
----
#Azure CLI on local Linux machine to get VHD image from Azure Marketplace
a) Login Azure CLI and list marketplace images
% az login --use-device-code
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code AQKKEXXXX to authenticate.
 
% az vm image list --all --publisher netapp --offer netapp-ontap-cloud --sku ontap_cloud_pgo_sn
...
{
"architecture": "x64",
"offer": "netapp-ontap-cloud",
"publisher": "netapp",
"sku": "ontap_cloud_pgo_sn",
"urn": "netapp:offer-example-one:sku_example_for_one::9.110.20220302",
"version": "9.110.20220302"
},
...
 
b) Create a new managed disk from the Marketplace image with the matching image version
% export urn="netapp:offer-example-one:sku_example_for_one::9.110.20220302"
% export diskName="9.110.20220302-managed-disk"
% export diskRG="new_rg_your_rg"
% az disk create -g $diskRG -n $diskName --image-reference $urn
% az disk grant-access --duration-in-seconds 36000 --access-level Read --name $diskName --resource-group $diskRG
{
  "accessSas": "https://md-kvls5fhl1ttw.blob.core.windows.net/h2q5jbdgsm3d/abcd?sv=2018-03-28&sr=b&si=bcxxxxxx-xxxx-437f-b019-xxxx4d7cb6e2&sigxxxxxxxxxKMG1LUq3dN66WerixxxxxxxxTnOVSFykV64%3D"
}
 
% export diskAccessSAS="https://md-kvls5fhl1ttw.blob.core.windows.net/h2q5jbdgsm3d/abcd?sv=2018-03-28&sr=b&si=bcxxxxxx-xxxx-437f-b019-xxxx4d7cb6e2&sigxxxxxxxxxxKMG1LUq3dN66WerixxxxxxxxTnOVSFykV64%3D"
#To automate the process, the SAS needs to be extracted from the standard output. This is not included in this guide.
 
c) export vhd from managed disk
Create a container with proper access level. As an example, a container named 'vi-images' with 'Container' access level is used here.
Get storage account access key, on Azure portal, 'Storage Accounts'/'signimgsa'/'Access Key'/'key1'/'key'/'show'/<copy>. There should be az command that can achieve the same, but this is not included in this guide.
% export storageAccountName="signimgsa2"
% export containerName="vm-images"
% export storageAccountKey="Y37GuQoAcId9vZq5TpEuPWxxxxxxxxxxxxxgK0iLdSYMvnMeu+AStAsCn1A=="
% export destBlobName="9.110.20220302.vhd"
 
% az storage blob copy start --source-uri $diskAccessSAS --destination-container $containerName --account-name $storageAccountName --account-key $storageAccountKey --destination-blob $destBlobName
 
{
  "client_request_id": "10xxxxxx-xxxx-xxxx-xxxx-0050xxxxxx7e",
  "copy_id": "9af6xxxx-xxxx-xxxx-xxxx-xxxxxe9432f3",
  "copy_status": "pending",
  "date": "2022-11-02T22:02:38+00:00",
  "etag": "\"0x8DXXXXXXXXXXXXX\"",
  "last_modified": "2022-11-02T22:02:39+00:00",
  "request_id": "5533645c-xxxx-xxxx-xxxx-efc7a1000000",
  "version": "2020-06-12",
  "version_id": null
}
 
#to check the status of the blob copying
% az storage blob show --name $destBlobName --container-name $containerName --account-name $storageAccountName
 
....
    "copy": {
      "completionTime": null,
      "destinationSnapshot": null,
      "id": "9af6xxxx-xxxx-xxxx-xxxx-xxxxxe9432f3",
      "incrementalCopy": null,
      "progress": "10737418752/10737418752",
      "source": "https://md-kvls5fhl1ttw.blob.core.windows.net/h2q5jbdgsm3d/abcd?sv=2018-03-28&sr=b&si=bcxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxb6e2",
      "status": "success",
      "statusDescription": null
    },
....
 
d) Download the generated image to your server, e.g., a SCS server or a windows PC.
On Linux in OpenLab, use "wget <URL of file signimgsa/Containers/vm-images/9.110.20220302.vhd>".
The URL is organized in a formatted way. For automation tasks, the following example could be used to derive the URL string. Otherwise, Azure CLI 'az' command could be issued to get the URL, which is not covered in this guide. URL Example:
https://signimgsa2.blob.core.windows.net/vm-images/9.110.20220302.vhd
 
Or, on windows, use Azure Storage Explorer to 'Attach to a resource' for fast download. Generate SAS of the image container: 'signimgsa'/'vm-images', then feed the SAS to Azure Storage Explorer.
 
Or, on Mac, mount your local user directory on your MAC so you can copy the exported VHD from the marketplace over and run openssl command against it from the cycl-server:
command+k (on Finder) and use this mountpoint:  smb://vsvhdrdur01prd.corp.netapp.com
login as "NETAPP\<sso>" and then enter password as a "Registered Guest"
 
e) Clean up the managed disk
az disk revoke-access --name $diskName --resource-group $diskRG
az disk delete --name $diskName --resource-group $diskRG --yes
----

====
